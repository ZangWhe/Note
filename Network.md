### 1 TCP

[一文彻底搞懂 TCP三次握手、四次挥手过程及原理 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/108504297)

[计算机网络——TCP的三次握手与四次挥手（超详细） - 特务依昂 - 博客园 (cnblogs.com)](https://www.cnblogs.com/tuyang1129/p/12435772.html#:~:text=2.2 TCP三次握手的过程 1 第一步 ：客户端的 TCP 程序首先向服务器的 TCP,：当客户端接收到 SYNACK 报文段后，它也将为 TCP 连接分配资源（缓存和变量），同时生成一条 SYNACK 报文段的确认报文，并发送给服务器。 )

##### TCP概述

TCP 提供面向有连接的通信传输，面向有连接是指在传送数据之前必须先建立连接，数据传送完成后要释放连接。

无论哪一方向另一方发送数据之前，都必须先在双方之间建立一条连接。在TCP/IP协议中，TCP协议提供可靠的连接服务，连接是通过**三次握手**进行初始化的。同时由于TCP协议是一种面向连接的、可靠的、基于字节流的运输层通信协议，TCP是**全双工模式**，所以需要**四次挥手**关闭连接。



##### TCP包首部

网络中传输的数据包由两部分组成：一部分是协议所要用到的首部，另一部分是上一层传过来的数据。

<img src="C:\Users\WangZhe\AppData\Roaming\Typora\typora-user-images\image-20231116211942804.png" alt="image-20231116211942804" style="zoom:50%;" />

下图为TCP首部的规范定义，定义了TCP协议是如何读取和解析数据



<img src="C:\Users\WangZhe\AppData\Roaming\Typora\typora-user-images\image-20231116212115848.png" alt="image-20231116212115848" style="zoom:50%;" />

- **TCP端口号**
  TCP的连接是需要四个要素确定唯一的一个连接：
  **（源IP，源端口号）+ （目地IP，目的端口号）**
  所以TCP首部预留了两个16位作为端口号的存储，而IP地址由上一层IP协议负责传递
  源端口号和目地端口各占16位两个字节，也就是端口的范围是2^16=65535
  另外1024以下是系统保留的，从1024-65535是用户使用的端口范围

- **TCP的序号和确认号**：
  **32位序号 seq**：Sequence number 缩写seq ，TCP通信过程中某一个传输方向上的字节流的每个字节的序号，通过这个来确认发送的数据**有序**，比如现在序列号为1000，发送了1000，下一个序列号就是2000。
  **32位确认号 ack**：Acknowledge number 缩写ack，TCP对上一次seq序号做出的确认号，用来响应TCP报文段，给收到的TCP报文段的序号seq加1。

- **TCP的标志位**
  每个TCP段都有一个目的，这是借助于TCP标志位选项来确定的，允许发送方或接收方指定哪些标志应该被使用，以便段被另一端正确处理。
  用的最广泛的标志是 **SYN**，**ACK** 和 **FIN**，用于建立连接，确认成功的段传输，最后终止连接。

1. **SYN**：简写为`S`，同步标志位，用于建立会话连接，同步序列号；
2. **ACK**： 简写为`.`，确认标志位，对已接收的数据包进行确认；
3. **FIN**： 简写为`F`，完成标志位，表示我已经没有数据要发送了，即将关闭连接；
4. PSH：简写为`P`，推送标志位，表示该数据包被对方接收后应立即交给上层应用，而不在缓冲区排队；
5. RST：简写为`R`，重置标志位，用于连接复位、拒绝错误和非法的数据包；
6. URG：简写为`U`，紧急标志位，表示数据包的紧急指针域有效，用来保证连接不被阻断，并督促中间设备尽快处理；



##### 三次握手

所谓三次握手(Three-way Handshake)，是指建立一个 TCP 连接时，需要客户端和服务器总共发送3个报文。

三次握手的目的是连接服务器指定端口，建立 TCP 连接，并同步连接双方的序列号和确认号，交换 TCP 窗口大小信息。

在 socket 编程中，客户端执行 connect() 时。将触发三次握手。

三次握手示意图如下：

<img src="C:\Users\WangZhe\AppData\Roaming\Typora\typora-user-images\image-20231116212918440.png" alt="image-20231116212918440" style="zoom:50%;" />

- **第一次握手**：
  客户端将TCP报文**标志位SYN置为1**，随机产生一个序号值seq=cliennt_isn，保存在TCP首部的序列号(Sequence Number)字段里，指明客户端打算连接的服务器的端口，并将该数据包发送给服务器端，发送完毕后，客户端进入`SYN_SENT`状态，等待服务器端确认。



- **第二次握手**：
  服务器端收到数据包后由标志位SYN=1知道客户端请求建立连接，服务器端将TCP报文**标志位SYN和ACK都置为1**，ack=client_isn+1，随机产生一个序号值seq=server_isn，并将该数据包发送给客户端以确认连接请求，服务器端进入`SYN_RCVD`状态。



- **第三次握手**：
  客户端收到确认后，检查ack是否为client_isn+1，ACK是否为1，如果正确则将标志位ACK置为1，ack=server_isn+1，并将该数据包发送给服务器端，

  服务器端检查ack是否为server_isn+1，ACK是否为1，如果正确则连接建立成功，客户端和服务器端进入`ESTABLISHED`状态，完成三次握手，随后客户端与服务器端之间可以开始传输数据了。



> 注意:上面写的ack和ACK，不是同一个概念：
>
> - 小写的ack代表的是头部的确认号Acknowledge number， 缩写ack，是对上一个包的序号进行确认的号，ack=seq+1。
> - 大写的ACK，则是上面说的TCP首部的标志位，用于标志的TCP包是否对上一个包进行了确认操作，如果确认了，则把ACK标志位设置成1。



##### 四次挥手

四次挥手即终止TCP连接，就是指断开一个TCP连接时，需要客户端和服务端总共发送4个包以确认连接的断开。

在socket编程中，这一过程由客户端或服务端任一方执行close来触发。

由于TCP连接是全双工的，因此，每个方向都必须要单独进行关闭，这一原则是当一方完成数据发送任务后，发送一个FIN来终止这一方向的连接，收到一个FIN只是意味着这一方向上没有数据流动了，即不会再收到数据了，但是在这个TCP连接上仍然能够发送数据，直到这一方向也发送了FIN。首先进行关闭的一方将执行主动关闭，而另一方则执行被动关闭。

四次挥手过程的示意图如下：

<img src="C:\Users\WangZhe\AppData\Roaming\Typora\typora-user-images\image-20231116213404067.png" alt="image-20231116213404067" style="zoom:50%;" />

挥手请求可以是Client端，也可以是Server端发起的，我们假设是Client端发起：

- **第一次挥手**： Client端发起挥手请求，向Server端发送标志位是FIN报文段，设置序列号seq，此时，Client端进入`FIN_WAIT_1`状态，这表示Client端没有数据要发送给Server端了。
- **第二次挥手**：Server端收到了Client端发送的FIN报文段，向Client端返回一个标志位是ACK的报文段，ack设为seq加1，Client端进入`FIN_WAIT_2`状态，Server端告诉Client端，我确认并同意你的关闭请求。
- **第三次挥手**： Server端向Client端发送标志位是FIN的报文段，请求关闭连接，同时Client端进入`LAST_ACK`状态。
- **第四次挥手** ： Client端收到Server端发送的FIN报文段，向Server端发送标志位是ACK的报文段，然后Client端进入`TIME_WAIT`状态。Server端收到Client端的ACK报文段以后，就关闭连接。此时，Client端等待**2MSL**的时间后依然没有收到回复，则证明Server端已正常关闭，那好，Client端也可以关闭连接了。



##### **1.1 为什么连接的时候是三次握手，关闭的时候却是四次握手？**

建立连接时因为当Server端收到Client端的SYN连接请求报文后，可以直接发送**SYN+ACK**报文。其中ACK报文是用来应答的，SYN报文是用来同步的。所以建立连接只需要三次握手。

由于TCP协议是一种面向连接的、可靠的、基于字节流的运输层通信协议，TCP是**全双工模式**。这就意味着，关闭连接时，当Client端发出FIN报文段时，只是表示Client端告诉Server端数据已经发送完毕了。当Server端收到FIN报文并返回ACK报文段，表示它已经知道Client端没有数据发送了，但是Server端还是可以发送数据到Client端的，所以Server很可能并不会立即关闭SOCKET，直到Server端把数据也发送完毕。当Server端也发送了FIN报文段时，这个时候就表示Server端也没有数据要发送了，就会告诉Client端，我也没有数据要发送了，之后彼此就会愉快的中断这次TCP连接。



#####  **1.2 为什么是三次握手而不是两次？**

  首先我们要明确，两次握手是必要的。第一次握手，客户端将`SYN`报文发送到服务器，服务器接收到报文后，即可确认客户端到服务器是可达的；而服务器向客户端发送响应的`SYNACK`报文，客户端接收到后，即可确认服务器到客户端也是可达的。至此，连接已经算是建立，那为什么还要有第三次握手呢？

  **主要原因：**客户端和服务器的握手过程，不仅仅是确认互相可达的过程，更重要的是一个**同步**的过程，`SYN`就是同步（Synchronize）的缩写。对于`TCP`报文段来说，**序号**是一个至关重要的部分，它保证了`TCP`传输数据的完整性。而我们上面也说过，`TCP`报文的初始序号不是从`0`开始的，而是一个随机的序号，**而所谓的同步，就是`TCP`客户端和服务器互相同步初始序号的过程**。第一次握手，客户端发送`SYN`报文，将自己的初始序号发送到了服务器，服务器接收到后，向客户端发送`SYNACK`报文段，告诉客户端已经收到了它的初始序号，同时在这个报文段中带上了自己的初始序号。这个时候，第三次握手的作用就出来了：**第三次握手实际上就是客户端在告诉服务器，自己已经收到了它的初始序号，完成了同步，可以开始相互传输数据了**。若没有第三次握手，服务器将无法保证客户端接收到了自己的`SYNACK`报文段，若此时`SYNACK`报文段丢失，客户端不知道服务器的初始序号，将无法处理之后到达客户端的数据。

  **次要原因：**我们假设client发出的第一个连接请求报文段并没有丢失，而是在某个网络结点长时间的滞留了，以致延误到连接释放以后的某个时间才到达server。本来这是一个早已失效的报文段。但server收到此失效的连接请求报文段后，就误认为是client再次发出的一个新的连接请求。于是就向client发出确认报文段，同意建立连接。假设不采用“三次握手”，那么只要server发出确认，新的连接就建立了。由于现在client并没有发出建立连接的请求，因此不会理睬server的确认，也不会向server发送数据。但server却以为新的运输连接已经建立，并一直等待client发来数据。这样，server的很多资源就白白浪费掉了。所以，采用“三次握手”的办法可以防止上述现象发生。例如刚才那种情况，client不会向server的确认发出确认。server由于收不到确认，就知道client并没有要求建立连接。

​		实际上，上面所述的第一点才是`TCP`三次握手的原因，第二个只能算是顺带的好处吧，从建立连接的报文被称为`SYN`（同步）就可以看出这点。



##### **1.3 为什么要等待2MSL？**

**MSL**：报文段最大生存时间，它是任何报文段被丢弃前在网络内的最长时间。

有以下两个原因：

- **第一点：保证TCP协议的全双工连接能够可靠关闭**：
  由于IP协议的不可靠性或者是其它网络原因，导致了Server端没有收到Client端的ACK报文，那么Server端就会在超时之后重新发送FIN，如果此时Client端的连接已经关闭处于`CLOESD`状态，那么重发的FIN就找不到对应的连接了，从而导致连接错乱，所以，Client端发送完最后的ACK不能直接进入`CLOSED`状态，而要保持`TIME_WAIT`，当再次收到FIN时，能够保证对方收到ACK，最后正确关闭连接。
- **第二点：保证这次连接的重复数据段从网络中消失**
  如果Client端发送最后的ACK直接进入`CLOSED`状态，然后又再向Server端发起一个新连接，这时不能保证新连接的与刚关闭的连接的端口号是不同的，也就是新连接和老连接的端口号可能一样了，那么就可能出现问题：如果前一次的连接某些数据滞留在网络中，这些延迟数据在建立新连接后到达Client端，由于新老连接的端口号和IP都一样，TCP协议就认为延迟数据是属于新连接的，新连接就会接收到脏数据，这样就会导致数据包混乱。所以TCP连接需要在TIME_WAIT状态等待2倍MSL，才能保证本次连接的所有数据在网络中消失。



##### 1.4 TCP三次握手过程中可以携带应用层数据吗

[TCP第三次握手能携带数据吗？做个实验就知道！ - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/373422503)

[TCP连接建立的三次握手过程可以携带数据吗？-阿里云开发者社区 (aliyun.com)](https://developer.aliyun.com/article/15118)

**在TCP三次握手过程中，第一次和第二次是不允许携带数据的**

原因是如果可以携带数据的话，首先是连接还未正式建立，此时发送数据是没有意义的，很可能会数据丢失，其次如果有人恶意在第一次握手过程中在SYN 报文中携带大量数据，给服务端大量发送垃圾数据，会导致服务器出现问题。



**TCP标准协议规范中，第三次握手包是允许传输数据的**

因为此时客户端已经处于established状态了



##### 1.5 ACK数据包，消耗TCP的序号吗

在TCP通信中，ACK（Acknowledgment）数据包本身不消耗TCP的序号。

相反，ACK数据包是用来确认已经成功接收到数据的，它包含了对方期望收到的下一个序号。在TCP的序列号机制中，每个TCP报文都有一个序列号字段（Seq），用于标识报文中数据的位置。而ACK字段用于确认收到的数据，指明期望接收的下一个数据的序号。

具体来说，在TCP通信中，发送方发送数据时会设置序列号（Seq），接收方在收到数据后，发送带有ACK标志的确认报文，其中的ACK字段指明期望接收的下一个序号。这样可以确保双方都知道对方已经成功接收了哪些数据，从而保证通信的可靠性。

总的来说，ACK数据包不仅不消耗TCP的序号，反而通过确认序号的方式来维护和确认数据的传输顺序，确保通信的可靠性。



---



